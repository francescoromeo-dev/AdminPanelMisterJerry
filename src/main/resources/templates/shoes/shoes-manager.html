<!doctype html>
<html lang="it" xmlns:th="https://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shoes manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/shoes-manager-style.css">

</head>

<body>

  <div class="container-my-4">
    <h1 class="text-center mb-3">Lista delle scarpe</h1>

    <!-- SEZIONE FILTRI -->
    <div class="filters-section">
      <form method="get" action="/shoes" class="filters-form">
        <div class="filters-row">
          <div class="filter-group">
            <label for="season">Stagione:</label>
            <select name="season" id="season" class="filter-select">
              <option value="">Tutte le stagioni</option>
              <option value="Autunno/Inverno"
                th:selected="${param.season != null and param.season[0] == 'Autunno/Inverno'}">Autunno/Inverno</option>
              <option value="Primavera/Estate"
                th:selected="${param.season != null and param.season[0] == 'Primavera/Estate'}">Primavera/Estate
              </option>
            </select>
          </div>

          <div class="filter-group">
            <label for="category">Categoria:</label>
            <select name="category" id="category" class="filter-select">
              <option value="">Tutte le categorie</option>
              <option value="Primi passi"
                th:selected="${param.category != null and param.category[0] == 'Primi passi'}">Primi passi</option>
              
              <option value="Bambini" th:selected="${param.category != null and param.category[0] == 'Bambini'}">Bambini
              </option>
            </select>
          </div>

          <div class="filter-actions">
            <button type="submit" class="btn btn-filter">Filtra</button>
            <a href="/shoes" class="btn btn-reset">Reset</a>
          </div>
        </div>
      </form>
    </div>

    <!-- PULSANTE AGGIUNGI -->
    <div class="action-section">
      <a class="btn btn-primary" href="/shoes/shoes-create">Aggiungi nuova scarpa</a>

      <!-- CONTATORE RISULTATI -->
      <div class="results-count">
        <span th:text="'Trovate ' + ${shoes.size()} + ' scarpe'">Trovate X scarpe</span>
      </div>
    </div>

    <table class="table mt-4">
      <thead>
        <tr>
          <th>Immagini</th>
          <th>Codice scarpa</th>
          <th>Stagione</th>
          <th>Categoria</th>
          <th>Data di creazione</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody class="table-group-divider">
        <tr th:each="shoes : ${shoes}">

          <!-- Visualizzazione multiple immagini con click per aprire modal -->
          <td>
            <div class="images-gallery" th:if="${shoes.hasImages()}">
              <div class="gallery-container" th:attr="data-image-ids=${#strings.listJoin(shoes.imageIdsList, ',')}, 
                               data-shoe-code=${shoes.code}" onclick="openImageModal(this)">

                <!-- Mostra fino a 3 immagini inline usando gli ID dal database -->
                <img th:each="imageId, iterStat : ${shoes.imageIdsList}" th:if="${iterStat.index < 3}"
                  th:src="@{'/images/' + ${imageId}}" alt="Foto scarpa" class="shoe-image-gallery">

                <!-- Indicatore se ci sono piÃ¹ di 3 immagini -->
                <div th:if="${shoes.imagesCount > 3}" class="more-images-indicator">
                  <span th:text="'+' + (${shoes.imagesCount - 3})">+X</span>
                </div>

                <!-- Contatore immagini -->
                <div class="images-count">
                  <span th:text="${shoes.imagesCount} + ' foto'">X foto</span>
                </div>
              </div>
            </div>

            <div th:unless="${shoes.hasImages()}" class="no-image">
              Nessuna<br>immagine
            </div>
          </td>

          <td th:text="${shoes.code}"></td>
          <td th:text="${shoes.season}"></td>
          <td th:text="${shoes.category}"></td>
          <td th:text="${shoes.createdAt.toString().substring(0,10)}"></td>

          <td style="white-space:nowrap">
            <a class="btn btn-primary btn-sm" th:href="@{/shoes/shoes-edit(id=${shoes.id})}">
              Modifica
            </a>

            <a class="btn btn-danger btn-sm" th:href="@{/shoes/delete(id=${shoes.id})}"
              onclick="return confirm('Sei sicuro di voler eliminare questa scarpa?')">
              Elimina
            </a>
          </td>
        </tr>

        <!-- MESSAGGIO NESSUN RISULTATO -->
        <tr th:if="${shoes.isEmpty()}">
          <td colspan="6" class="no-results">
            <div class="no-results-content">
              <span>ðŸ”­</span>
              <p>Nessuna scarpa trovata con i filtri selezionati</p>
              <a href="/shoes" class="btn btn-reset btn-sm">Rimuovi filtri</a>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- MODAL PER VISUALIZZARE LE IMMAGINI -->
  <div id="imageModal" class="image-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Visualizza immagini</h5>
        <button class="close-btn" onclick="closeImageModal()" title="Chiudi">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="image-gallery">
          <div class="main-image-container">
            <img id="mainImage" class="main-image" src="" alt="Immagine scarpa">
            <button class="nav-button prev" onclick="previousImage()" title="Immagine precedente">â€¹</button>
            <button class="nav-button next" onclick="nextImage()" title="Immagine successiva">â€º</button>
            <div class="image-counter">
              <span id="imageCounter">1 / 1</span>
            </div>
          </div>
          <div class="thumbnails-container" id="thumbnailsContainer">
            <!-- Le thumbnail verranno generate dinamicamente -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLlhNTkCfHzAVBReH9diLlhNTkCfHzAVBReH9diLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
    crossorigin="anonymous"></script>

  <script>
    let currentImageIds = [];
    let currentImageIndex = 0;
    let currentShoeCode = '';

    function openImageModal(element) {
      const imageIdsString = element.getAttribute('data-image-ids');
      const shoeCode = element.getAttribute('data-shoe-code');

      currentImageIds = imageIdsString.split(',').filter(id => id.trim() !== '').map(id => id.trim());
      currentShoeCode = shoeCode;
      currentImageIndex = 0;

      if (currentImageIds.length === 0) {
        return;
      }

      // Aggiorna il titolo del modal
      document.getElementById('modalTitle').textContent = `Immagini di ${shoeCode}`;

      // Mostra il modal
      const modal = document.getElementById('imageModal');
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';

      // Aggiunge/rimuove classe per gestire i pulsanti di navigazione
      const mainContainer = document.querySelector('.main-image-container');
      if (currentImageIds.length === 1) {
        mainContainer.classList.add('single-image');
      } else {
        mainContainer.classList.remove('single-image');
      }

      // Carica la prima immagine
      loadImage(0);
      generateThumbnails();
    }

    function closeImageModal() {
      const modal = document.getElementById('imageModal');
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }

    function loadImage(index) {
      if (index < 0 || index >= currentImageIds.length) return;

      currentImageIndex = index;
      const imagePath = `/images/${currentImageIds[index]}`;

      const mainImage = document.getElementById('mainImage');
      mainImage.src = imagePath;

      // Aggiorna il contatore
      document.getElementById('imageCounter').textContent =
        `${currentImageIndex + 1} / ${currentImageIds.length}`;

      // Aggiorna le thumbnails attive
      updateThumbnailsActiveState();
    }

    function previousImage() {
      const newIndex = (currentImageIndex - 1 + currentImageIds.length) % currentImageIds.length;
      loadImage(newIndex);
    }

    function nextImage() {
      const newIndex = (currentImageIndex + 1) % currentImageIds.length;
      loadImage(newIndex);
    }

    function generateThumbnails() {
      const container = document.getElementById('thumbnailsContainer');
      container.innerHTML = '';

      currentImageIds.forEach((imageId, index) => {
        const thumbnail = document.createElement('img');
        thumbnail.src = `/images/${imageId}`;
        thumbnail.alt = `Thumbnail ${index + 1}`;
        thumbnail.className = 'thumbnail';
        thumbnail.onclick = () => loadImage(index);

        if (index === currentImageIndex) {
          thumbnail.classList.add('active');
        }

        container.appendChild(thumbnail);
      });
    }

    function updateThumbnailsActiveState() {
      const thumbnails = document.querySelectorAll('.thumbnail');
      thumbnails.forEach((thumb, index) => {
        thumb.classList.toggle('active', index === currentImageIndex);
      });
    }

    // Chiudi il modal quando si clicca fuori dal contenuto
    document.getElementById('imageModal').onclick = function (event) {
      if (event.target === this) {
        closeImageModal();
      }
    };

    // Supporto per i tasti freccia
    document.addEventListener('keydown', function (event) {
      const modal = document.getElementById('imageModal');
      if (!modal.classList.contains('show')) return;

      switch (event.key) {
        case 'ArrowLeft':
          previousImage();
          break;
        case 'ArrowRight':
          nextImage();
          break;
        case 'Escape':
          closeImageModal();
          break;
      }
    });

    // Previene il comportamento predefinito del drag sulle immagini
    document.addEventListener('dragstart', function (e) {
      if (e.target.tagName === 'IMG') {
        e.preventDefault();
      }
    });
  </script>
</body>

</html>